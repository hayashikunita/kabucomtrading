<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Trading Chart - kabucomtrading</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .controls {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }
        .controls button {
            margin: 5px;
            padding: 8px 15px;
            cursor: pointer;
            border: 1px solid #ccc;
            background-color: #fff;
            border-radius: 3px;
        }
        .controls button:hover {
            background-color: #e0e0e0;
        }
        .controls button.active {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        .data-source-group {
            margin-bottom: 10px;
        }
        .duration-group {
            margin-bottom: 10px;
        }
        .product-code-group {
            margin-bottom: 10px;
        }
        #dashboard_div{
            width: 100%;
            max-width: 1200px;
            border: 1px solid #ccc;
        }
        #chart_div{
            height:500px;
            border-bottom: 1px solid #ccc;
        }
        #filter_div{
            height:50px;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            background-color: #e3f2fd;
            border-left: 4px solid #2196F3;
            border-radius: 3px;
        }
    </style>

    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script type="text/javascript">
        google.charts.load('current', {'packages':['corechart', 'controls']});

        var config = {
            dataSource: 'yahoo',  // 'kabusapi' or 'yahoo'
            api:{
                enable: true,
                interval: 1000 * 5  // Yahoo Financeの場合は更新間隔を長めに
            },
            candlestick:{
                product_code: '1459',
                duration: '1m',
                limit: 365,
            }
        };

        function changeDataSource(source) {
            config.dataSource = source;
            
            // ボタンのアクティブ状態を更新
            $('.data-source-btn').removeClass('active');
            $('#btn-' + source).addClass('active');
            
            // ステータス更新
            updateStatus('データソースを ' + (source === 'yahoo' ? 'Yahoo Finance' : 'kabusapi') + ' に変更しました');
            
            // データを再取得
            fetchAndDrawChart();
        }

        function changeDuration(duration) {
            config.candlestick.duration = duration;
            
            // ボタンのアクティブ状態を更新
            $('.duration-btn').removeClass('active');
            $('#btn-duration-' + duration).addClass('active');
            
            updateStatus('時間軸を ' + duration + ' に変更しました');
            
            // データを再取得
            fetchAndDrawChart();
        }

        function updateProductCode() {
            var newCode = $('#product-code-input').val().trim();
            if (!newCode) {
                updateStatus('エラー: 銘柄コードを入力してください');
                return;
            }
            config.candlestick.product_code = newCode;
            updateStatus('銘柄を ' + newCode + ' に変更しました');
            fetchAndDrawChart();
        }

        function updateStatus(message) {
            $('#status-message').text(message);
        }

        function fetchAndDrawChart() {
            if (!config.api.enable) {
                return;
            }
            
            var apiEndpoint = config.dataSource === 'yahoo' ? '/api/yahoo/candle/' : '/api/candle/';
            
            var params = {
                "product_code": config.candlestick.product_code,
                "limit": config.candlestick.limit,
                "duration": config.candlestick.duration,
                // テクニカル指標を無効化してシンプルに
                // "sma": "true",
                // "smaPeriod1": "7",
                // "smaPeriod2": "14",
                // "smaPeriod3": "50",
            };

            updateStatus('データ取得中...');

            $.get(apiEndpoint, params)
                .done(function (data) {
                    if (!data.candles || data.candles.length === 0) {
                        updateStatus('エラー: データがありません');
                        return;
                    }
                    
                    updateStatus('データ取得成功: ' + data.candles.length + '件のローソク足データ');
                    drawChart(data);
                })
                .fail(function(xhr, status, error) {
                    updateStatus('エラー: データ取得失敗 - ' + error);
                    console.error('API Error:', error);
                });
        }

        function drawChart(data) {
            console.log('Drawing chart with data:', data);
            
            // Google ChartsでシンプルなOHLCチャートを描画
            var chartData = new google.visualization.DataTable();
            chartData.addColumn('string', 'Time');
            chartData.addColumn('number', 'Low');
            chartData.addColumn('number', 'Open');
            chartData.addColumn('number', 'Close');
            chartData.addColumn('number', 'High');

            // データ行を追加
            for (var i = 0; i < data.candles.length; i++) {
                var candle = data.candles[i];
                var timeStr = new Date(candle.time).toLocaleString('ja-JP');
                
                chartData.addRow([
                    timeStr,
                    candle.low,
                    candle.open,
                    candle.close,
                    candle.high
                ]);
            }

            var options = {
                legend: 'none',
                candlestick: {
                    fallingColor: { strokeWidth: 0, fill: '#a52714'},
                    risingColor: { strokeWidth: 0, fill: '#0f9d58'}
                },
                hAxis: {
                    slantedText: true,
                    slantedTextAngle: 45
                },
                chartArea: {
                    width: '80%',
                    height: '70%'
                }
            };

            var chart = new google.visualization.CandlestickChart(document.getElementById('chart_div'));
            
            try {
                chart.draw(chartData, options);
                console.log('Chart drawn successfully');
            } catch (e) {
                console.error('Error drawing chart:', e);
                updateStatus('エラー: チャート描画失敗 - ' + e.message);
            }
        }

        // ページ読み込み時の初期化
        google.charts.setOnLoadCallback(function() {
            // 初期状態のボタンをアクティブに
            $('#btn-' + config.dataSource).addClass('active');
            $('#btn-duration-' + config.candlestick.duration).addClass('active');
            
            // Enterキーでも銘柄更新できるようにする
            $('#product-code-input').on('keypress', function(e) {
                if (e.key === 'Enter') {
                    updateProductCode();
                }
            });
            
            // 初回データ取得
            fetchAndDrawChart();
            
            // 定期的にデータを更新（Yahoo Financeの場合は無効化推奨）
            if (config.dataSource === 'kabusapi') {
                setInterval(fetchAndDrawChart, config.api.interval);
            }
        });

    </script>
</head>
<body>

<h1>Trading Chart - kabucomtrading</h1>

<div class="controls">
    <div class="data-source-group">
        <strong>データソース:</strong>
        <button id="btn-yahoo" class="data-source-btn" onclick="changeDataSource('yahoo')">Yahoo Finance</button>
        <button id="btn-kabusapi" class="data-source-btn" onclick="changeDataSource('kabusapi')">kabusapi</button>
    </div>
    
    <div class="product-code-group">
        <strong>銘柄コード:</strong>
        <input type="text" id="product-code-input" value="1459" style="padding: 8px; width: 120px; margin-left: 5px; border: 1px solid #ccc; border-radius: 3px;">
        <span style="margin-left: 5px; color: #666; font-size: 0.9em;">(例: 1459, 7203, 9984)</span>
        <button onclick="updateProductCode()" style="padding: 8px 15px; background-color: #4CAF50; color: white; border: none; border-radius: 3px; cursor: pointer; margin-left: 10px;">チャート更新</button>
    </div>
    
    <div class="duration-group">
        <strong>時間軸:</strong>
        <button id="btn-duration-5s" class="duration-btn" onclick="changeDuration('5s')">5秒足</button>
        <button id="btn-duration-1m" class="duration-btn" onclick="changeDuration('1m')">1分足</button>
        <button id="btn-duration-1h" class="duration-btn" onclick="changeDuration('1h')">1時間足</button>
    </div>
</div>

<div class="status" id="status-message">
    初期化中...
</div>

<div id="dashboard_div">
    <div id="chart_div"></div>
</div>

</body>
</html>